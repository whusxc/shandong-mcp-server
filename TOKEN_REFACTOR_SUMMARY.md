# Tokenåˆ·æ–°æœºåˆ¶é‡æ„æ€»ç»“

## ğŸ”„ é‡æ„å†…å®¹

åŸºäº`quick_token_test.py`æˆåŠŸæµ‹è¯•ç”¨ä¾‹ï¼Œå¯¹MCPæœåŠ¡å™¨ä¸­çš„tokenåˆ·æ–°æœºåˆ¶è¿›è¡Œäº†å…¨é¢é‡æ„ã€‚

## ğŸ“‹ é‡æ„çš„å‡½æ•°

### 1. `get_oauth_token()` - MCPå·¥å…·å‡½æ•°
âœ… **å®Œå…¨æŒ‰ç…§æµ‹è¯•ç”¨ä¾‹é‡æ„**
- URL: `http://172.20.70.141/api/oauth/token`
- è¯·æ±‚å‚æ•°æ ¼å¼å®Œå…¨åŒ¹é…æµ‹è¯•ç”¨ä¾‹
- å“åº”è§£æé€»è¾‘ï¼š`data.token` + `data.tokenHead`
- ç»„è£…å®Œæ•´tokenï¼š`f"{token_head} {token}"`

### 2. `_auto_refresh_token()` - å†…éƒ¨å‡½æ•°
âœ… **ç›´æ¥ä½¿ç”¨æµ‹è¯•ç”¨ä¾‹é€»è¾‘**
- ç§»é™¤äº†å¯¹`get_oauth_token`çš„è°ƒç”¨
- ç›´æ¥å®ç°HTTPè¯·æ±‚é€»è¾‘
- ä½¿ç”¨ç›¸åŒçš„è¯·æ±‚æ ¼å¼å’Œå“åº”è§£æ

### 3. `refresh_token_auto()` - MCPå·¥å…·å‡½æ•°
âœ… **é‡æ„ä¸ºç›´æ¥è°ƒç”¨æ¨¡å¼**
- ä¸å†ä¾èµ–`get_oauth_token`å‡½æ•°
- ç›´æ¥å®ç°tokenè·å–é€»è¾‘
- æä¾›æ›´è¯¦ç»†çš„å“åº”ä¿¡æ¯

## ğŸ¯ é‡æ„ä¼˜åŠ¿

### 1. **ç»Ÿä¸€çš„é€»è¾‘**
- æ‰€æœ‰tokenç›¸å…³å‡½æ•°ä½¿ç”¨ç›¸åŒçš„è¯·æ±‚æ ¼å¼
- ç»Ÿä¸€çš„å“åº”è§£æé€»è¾‘
- å‡å°‘äº†å‡½æ•°é—´çš„ä¾èµ–å…³ç³»

### 2. **ç²¾ç¡®åŒ¹é…æµ‹è¯•ç”¨ä¾‹**
```python
# è¯·æ±‚æ ¼å¼
url = "http://172.20.70.141/api/oauth/token"
params = {
    "scopes": "web",
    "client_secret": "123456", 
    "client_id": "test",
    "grant_type": "password",
    "username": "edu_admin",
    "password": "123456"
}
body = {
    "username": "edu_admin",
    "password": "123456"
}

# å“åº”è§£æ
if 'data' in data and 'token' in data['data']:
    token = data['data']['token']
    token_head = data['data'].get('tokenHead', 'Bearer')
    full_token = f"{token_head} {token}"
```

### 3. **æ›´å¥½çš„é”™è¯¯å¤„ç†**
- è¯¦ç»†çš„æ—¥å¿—è®°å½•
- ç²¾ç¡®çš„é”™è¯¯ä¿¡æ¯
- å“åº”æ ¼å¼éªŒè¯

### 4. **æ€§èƒ½ä¼˜åŒ–**
- å‡å°‘äº†å‡½æ•°è°ƒç”¨å±‚çº§
- ç›´æ¥çš„HTTPè¯·æ±‚å¤„ç†
- é¿å…äº†JSONåºåˆ—åŒ–/ååºåˆ—åŒ–çš„å¼€é”€

## ğŸ”§ ä½¿ç”¨æ–¹å¼

### è‡ªåŠ¨åˆ·æ–°ï¼ˆæ¨èï¼‰
```python
# ç³»ç»Ÿä¼šè‡ªåŠ¨æ£€æµ‹tokenè¿‡æœŸå¹¶åˆ·æ–°
result = await coverage_aspect_analysis(bbox=[110.0, 19.0, 111.0, 20.0])
```

### æ‰‹åŠ¨åˆ·æ–°
```python
# ç›´æ¥è°ƒç”¨é‡æ„åçš„å·¥å…·
result = await refresh_token_auto()
```

### è‡ªå®šä¹‰è·å–
```python
# ä½¿ç”¨é‡æ„åçš„è·å–å·¥å…·
result = await get_oauth_token(username="edu_admin", password="123456")
```

## âœ… éªŒè¯çŠ¶æ€

- âœ… è¯·æ±‚æ ¼å¼ä¸æˆåŠŸæµ‹è¯•ç”¨ä¾‹å®Œå…¨ä¸€è‡´
- âœ… å“åº”è§£æé€»è¾‘åŒ¹é…å®é™…APIæ ¼å¼
- âœ… é”™è¯¯å¤„ç†æœºåˆ¶å®Œå–„
- âœ… å…¨å±€tokenæ›´æ–°æ­£å¸¸
- â“ å†…ç½‘ç¯å¢ƒå®é™…æµ‹è¯•ï¼ˆå¾…éªŒè¯ï¼‰

## ğŸš€ éƒ¨ç½²å»ºè®®

1. **å†…ç½‘ç¯å¢ƒæµ‹è¯•**ï¼š
   ```bash
   python quick_token_test.py  # éªŒè¯ç½‘ç»œè¿é€šæ€§
   python shandong_mcp_server_enhanced.py --mode stdio  # å¯åŠ¨MCPæœåŠ¡å™¨
   ```

2. **åŠŸèƒ½éªŒè¯**ï¼š
   - è°ƒç”¨`refresh_token_auto`éªŒè¯tokenè·å–
   - è°ƒç”¨`coverage_aspect_analysis`éªŒè¯è‡ªåŠ¨åˆ·æ–°
   - æ£€æŸ¥æ—¥å¿—ç¡®è®¤tokenæ›´æ–°æˆåŠŸ

ç°åœ¨MCPæœåŠ¡å™¨çš„tokenåˆ·æ–°æœºåˆ¶åº”è¯¥èƒ½åœ¨å†…ç½‘ç¯å¢ƒä¸­æ­£å¸¸å·¥ä½œäº†ï¼ 